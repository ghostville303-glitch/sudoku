<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sudoku Ultra Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --bg: #0a0a0a; --text: #f0f0f0; --grid: #333; 
            --cell: #1a1a1a; --fixed: #4dabf7; --selected: #2c2c2c; 
            --highlight: #1e3a5f; --wrong: #ff5252;
        }
        /* Anti-Drop CSS */
        html, body { 
            position: fixed; overflow: hidden; width: 100%; height: 100%; 
            background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; 
            display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px;
            touch-action: none; /* Stops browser bounce */
        }
        .header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; margin-bottom: 10px; }
        select { background: #222; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 5px; }
        
        #grid { 
            display: grid; grid-template-columns: repeat(9, 1fr); 
            border: 2px solid var(--grid); background: var(--grid); 
            gap: 1px; width: 95vw; max-width: 400px; aspect-ratio: 1; 
        }
        .cell { 
            background: var(--cell); display: flex; align-items: center; justify-content: center; 
            font-size: 22px; cursor: pointer; transition: 0.05s;
        }
        .cell.selected { background: var(--selected); box-shadow: inset 0 0 0 2px #4dabf7; }
        .cell.highlight-num { background: var(--highlight) !important; }
        .cell.fixed { color: var(--fixed); font-weight: bold; }
        .cell.error { background: #421a1a !important; color: var(--wrong) !important; }
        
        .cell:nth-child(3n) { border-right: 2px solid var(--grid); }
        .cell:nth-child(9n) { border-right: none; }
        .cell:nth-child(n+19):nth-child(-n+27), .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid var(--grid); }

        .btn-row { display: flex; gap: 8px; margin-top: 15px; width: 95vw; max-width: 400px; }
        button { padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; flex: 1; background: #2196f3; color: white; }

        #numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 15px; width: 95vw; max-width: 400px; }
        .num-btn { padding: 18px 0; background: #222; border-radius: 8px; text-align: center; font-weight: bold; font-size: 22px; border: 1px solid #444; }
        .num-btn.active-num { background: #2196f3; border-color: #fff; }
    </style>
</head>
<body>
    <div class="header">
        <select id="diff" onchange="newGame()">
            <option value="35">Easy</option>
            <option value="50" selected>Mid</option>
            <option value="65">Hard</option>
        </select>
        <div style="font-weight: bold; color: #4dabf7;">SUDOKU PRO</div>
    </div>
    <div id="grid"></div>
    <div class="btn-row">
        <button onclick="newGame()">NEW</button>
        <button onclick="solveBoard()">SOLVE</button>
        <button onclick="erase()" style="background:#b71c1c">ERASER</button>
    </div>
    <div id="numpad"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        // The Anti-Drop Hack
        tg.isVerticalSwipesEnabled = false; 

        let board = [], solution = [], isFixed = [], selected = null, activeNum = null;

        function solve(grid) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (grid[r][c] == 0) {
                        for (let n of [1,2,3,4,5,6,7,8,9].sort(() => Math.random()-0.5)) {
                            if (isValid(grid, r, c, n)) {
                                grid[r][c] = n;
                                if (solve(grid)) return true;
                                grid[r][c] = 0;
                            }
                        }
                        return false;
                    }
                }
            }
            return true;
        }

        function isValid(grid, r, c, n) {
            for (let i = 0; i < 9; i++) if (grid[r][i] == n || grid[i][c] == n) return false;
            let sr = r - r % 3, sc = c - c % 3;
            for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (grid[i + sr][j + sc] == n) return false;
            return true;
        }

        function newGame() {
            let fullGrid = Array.from({length:9}, () => Array(9).fill(0));
            solve(fullGrid);
            solution = fullGrid.map(row => [...row]);
            board = fullGrid.map(row => [...row]);
            isFixed = Array.from({length:9}, () => Array(9).fill(false));
            let count = parseInt(document.getElementById('diff').value);
            for (let i = 0; i < count; i++) {
                let r = Math.floor(Math.random()*9), c = Math.floor(Math.random()*9);
                if (board[r][c] !== 0) board[r][c] = 0; else i--;
            }
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(board[r][c] !== 0) isFixed[r][c] = true;
            selected = null; activeNum = null; render();
        }

        function render() {
            const container = document.getElementById('grid');
            container.innerHTML = '';
            board.forEach((row, r) => {
                row.forEach((val, c) => {
                    const cell = document.createElement('div');
                    cell.className = 'cell' + (isFixed[r][c] ? ' fixed' : '') + (selected?.r === r && selected?.c === c ? ' selected' : '');
                    let cur = activeNum || (selected ? board[selected.r][selected.c] : null);
                    if (cur && val === cur) cell.classList.add('highlight-num');
                    if (val !== 0 && !isFixed[r][c] && val !== solution[r][c]) cell.classList.add('error');
                    cell.innerText = val || '';
                    cell.onclick = () => handleCellClick(r, c);
                    container.appendChild(cell);
                });
            });
            const btns = document.querySelectorAll('.num-btn');
            btns.forEach((btn, i) => btn.className = 'num-btn' + (activeNum === (i+1) ? ' active-num' : ''));
        }

        function handleCellClick(r, c) {
            if (activeNum && !isFixed[r][c]) {
                board[r][c] = activeNum;
                if (board[r][c] !== solution[r][c]) tg.HapticFeedback.notificationOccurred('error');
                else tg.HapticFeedback.impactOccurred('light');
            }
            selected = {r, c}; render();
        }

        function selectNum(n) {
            activeNum = (activeNum === n) ? null : n;
            if (selected && !isFixed[selected.r][selected.c] && activeNum) {
                board[selected.r][selected.c] = activeNum;
                if (board[selected.r][selected.c] !== solution[selected.r][selected.c]) tg.HapticFeedback.notificationOccurred('error');
            }
            render();
        }

        function solveBoard() { board = solution.map(row => [...row]); render(); tg.HapticFeedback.notificationOccurred('success'); }
        function erase() { if(selected && !isFixed[selected.r][selected.c]) { board[selected.r][selected.c] = 0; render(); } }

        const numpad = document.getElementById('numpad');
        for(let i=1; i<=9; i++) {
            const btn = document.createElement('div');
            btn.className = 'num-btn'; btn.innerText = i;
            btn.onclick = () => selectNum(i);
            numpad.appendChild(btn);
        }
        newGame();
    </script>
</body>
</html>
